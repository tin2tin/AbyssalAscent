<!DOCTYPE html>
<html>
<head>
    <title>Abyssal Ascent - Gap & Speed Refine</title>
    <style>
        /* ... (CSS remains the same) ... */
        body { margin: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; height: 100vh; background: #000000; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: pan-y; }
        canvas { flex-grow: 1; width: 100%; border: 2px solid #00111a; background: #000000; display: block; aspect-ratio: 600 / 900; object-fit: contain; touch-action: none; }
        #top-right-controls { position: absolute; top: 10px; right: 10px; left: auto; z-index: 100; display: none; }
        #pause-button { padding: 8px 15px; background: linear-gradient(to bottom, #4A6B7E, #3A5060); border: 2px solid #1C2A34; border-radius: 5px; color: white; cursor: pointer; font-family: sans-serif; font-size: 16px; white-space: nowrap; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); user-select: none; touch-action: manipulation; }
        #pause-button:active { background: linear-gradient(to bottom, #3A5060, #4A6B7E); box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5); }
        #mobile-controls-container { position: absolute; bottom: 0; left: 0; width: 100%; z-index: 10; }
        #mobile-controls { display: none; width: 100%; max-width: 600px; margin: 0 auto; padding: 10px 5px; box-sizing: border-box; justify-content: space-between; align-items: flex-end; }
        #mobile-controls .control-group { display: flex; gap: 25px; }
        #mobile-controls button { width: 180px; height: 180px; display: flex; justify-content: center; align-items: center; background: linear-gradient(to bottom, #20B2AA, #008080); border: 2px solid #004D40; border-radius: 50%; color: white; font-size: 30px; font-weight: bold; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); user-select: none; touch-action: manipulation; text-align: center; line-height: 1; }
        #mobile-controls button:active { background: linear-gradient(to bottom, #008080, #20B2AA); box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5); }
        #pause-menu { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,10,20,0.9); z-index: 200; flex-direction: column; justify-content: center; align-items: center; color: #E0F7FA; font-size: 24px; }
        #pause-menu h2 { font-size: 4em; margin-bottom: 30px; color: #FFEB3B; text-shadow: 2px 2px 5px rgba(0,0,0,0.7); }
        #pause-menu button { padding: 15px 30px; margin: 10px 0; font-size: 1.5em; background: linear-gradient(to bottom, #20B2AA, #008080); border: 2px solid #004D40; border-radius: 8px; color: white; cursor: pointer; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); user-select: none; touch-action: manipulation; }
        #pause-menu button:active { background: linear-gradient(to bottom, #008080, #20B2AA); box-shadow: inset 1px 1px 3px rgba(0,0,0,0.5); }
        #close-app-button { background: linear-gradient(to bottom, #E57373, #C62828) !important; }
        #close-app-button:active { background: linear-gradient(to bottom, #C62828, #E57373) !important; }
    </style>
</head>
<body>
    <div id="game-super-container">
        <div id="top-right-controls"><button id="pause-button">PAUSE</button></div>
        <canvas id="gameCanvas"></canvas>
        <div id="mobile-controls-container">
            <div id="mobile-controls"> <div class="control-group"> <button id="left-btn">LEFT</button> <button id="right-btn">RIGHT</button> </div> <button id="jump-btn">PUSH</button> </div>
        </div>
    </div>
    <div id="pause-menu"> <h2>PAUSED</h2> <button id="resume-button">Resume Ascent</button> <button id="restart-from-pause">New Ascent</button> <button id="mute-button-from-pause">Mute Echoes</button> <button id="close-app-button">Return to Surface</button> </div>

    <script>
        // console.log("Script started - Abyssal Ascent GapSpeedRefine_v1");

        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');
        const TARGET_CANVAS_WIDTH = 600; const TARGET_CANVAS_HEIGHT = 900;
        canvas.width = TARGET_CANVAS_WIDTH; canvas.height = TARGET_CANVAS_HEIGHT;
        const isAndroid = /Android/i.test(navigator.userAgent);
        const gameSpeedFactor = isAndroid ? 0.65 : 1.0;

        const BUOYANCY = -0.16 * gameSpeedFactor; const PLAYER_BASE_SPEED = 3.3 * gameSpeedFactor;
        const PLAYER_BASE_PUSH_INITIAL = 7.8 * gameSpeedFactor;
        const WATER_RESISTANCE_V = 0.97;
        const WATER_RESISTANCE_H = 0.96;
        const PLATFORM_ATTACH_PULL_UP = 0.15 * gameSpeedFactor;

        const MIN_CEILING_UNDERSIDE_GAP_FACTOR = 0.35;
        const MAX_CEILING_UNDERSIDE_GAP_FACTOR = 0.50;

        const BOTTOM_DEATH_FLOOR_HEIGHT = 20;
        const EXIT_CEILING_HEIGHT = 25; const TOP_SURFACE_DEATH_Y = 10;
        const EXIT_CEILING_UNDERSIDE_Y = TOP_SURFACE_DEATH_Y + EXIT_CEILING_HEIGHT + 25;
        const PLATFORM_CORNER_RADIUS = 10;
        const STARTING_DEPTH = 1000; const DEPTH_DECREASE_PER_LEVEL = 7;

        const keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
            const keyLower = e.key.toLowerCase();
            if (keyLower === ' ') { if (gameState !== 'playing' && gameState !== 'paused') { e.preventDefault(); }
            } else if (keyLower === 'p' || keyLower === 'escape') { if (gameState === 'playing' || gameState === 'gameOver' || gameState === 'gameWon') { e.preventDefault(); } }
        });
        window.addEventListener('keyup',e=>keys[e.key]=false);

        const topRightControls=document.getElementById('top-right-controls');const mobileControls=document.getElementById('mobile-controls');const pauseMenu=document.getElementById('pause-menu');const pauseButton=document.getElementById('pause-button');const resumeButton=document.getElementById('resume-button');const closeAppButton=document.getElementById('close-app-button');const restartFromPauseButton=document.getElementById('restart-from-pause');const muteButtonFromPause=document.getElementById('mute-button-from-pause');const leftBtn=document.getElementById('left-btn');const rightBtn=document.getElementById('right-btn');const jumpBtn=document.getElementById('jump-btn');

        let player={x:50,y:50,radius:15,baseRadius:15,maxRadius:26,radiusGrowthPerStar:0.25,vx:0,vy:0,isAttached:false,lives:3,scale:1,canTakeDamage:true,damageCooldownTimeout:null,invincible:false,invincibleTimer:0,speedBoost:false,speedBoostTimer:0,baseSpeed:PLAYER_BASE_SPEED,currentPushForce: PLAYER_BASE_PUSH_INITIAL,attachedPlatform:null};
        let platforms=[];let enemies=[];let stars=[];let powerUps=[];let gameEffectParticles=[];
        let ambientBubbles=[]; let foregroundBubbles = []; // Added foregroundBubbles
        let exitPlatform=null;
        let airCollected=0; let internalLevel=1; let currentDepth = STARTING_DEPTH;
        let gameState='start';let platformBaseSpeed=0.45*gameSpeedFactor;
        let currentGradientColors=['#000000','#000000','#000000']; let gradientBaseHue = 200;
        let totalAirHighScore=parseInt(localStorage.getItem('abyssalAscentTotalAir_v9')||'0',10);
        let gameOverFinalAir=0;let transitionAlpha=0;let transitionSpeed=0.03;let transitionCallback=null;let playerCanMove=false;let gameOver=false; let justRestartedFromGameOver = false;
        const SPECIAL_PLATFORM_TYPES=['disappearing_coral','bouncy_vent','conveyor_current'];
        let seaFloorDecorations = [];

        function updateUI(){}
        function updateUIVisibility(){const showMobile=isAndroid&& (gameState==='start'||gameState==='playing'||gameState==='gameOver'||gameState==='gameWon'||gameState==='transitioning');mobileControls.style.display=showMobile?'flex':'none';if(gameState==='start'||gameState==='gameOver'||gameState==='gameWon'){topRightControls.style.display='block';pauseMenu.style.display='none';}else if(gameState==='playing'||gameState==='transitioning'){topRightControls.style.display='block';pauseMenu.style.display='none';}else if(gameState==='paused'){topRightControls.style.display='none';pauseMenu.style.display='flex';}}
        let audioContext;let abyssalDroneMusic;let cyclingPlatformsMusic;let isMuted=false;function createOscillatorSound(f,duration,t,pStartTime=0){if(isMuted)return;if(gameState!=='playing'&&gameState!=='levelComplete'&&gameState!=='gameWon')return;if(!isFinite(f)||!isFinite(duration)||!isFinite(pStartTime)){console.error("Non-finite audio param:",{f,duration,pStartTime});return;}if(!audioContext){try{audioContext=new(window.AudioContext||window.webkitAudioContext)();}catch(e){console.warn("No AudioCtx");return;}}if(!audioContext)return;const actualStartTime=audioContext.currentTime+pStartTime;const osc=audioContext.createOscillator();const gain=audioContext.createGain();osc.type=t;osc.frequency.setValueAtTime(f,actualStartTime);gain.gain.setValueAtTime(0.18,actualStartTime);gain.gain.exponentialRampToValueAtTime(0.001,actualStartTime+duration);osc.connect(gain);gain.connect(audioContext.destination);osc.start(actualStartTime);osc.stop(actualStartTime+duration);}
        function playPushFromCeilingSound(){createOscillatorSound(120,0.15,'sawtooth');createOscillatorSound(180,0.1,'sawtooth',0.02);emitParticles(player.x,player.y-player.radius,'push_down_burst');}
        function playAttachToCeilingSound(){createOscillatorSound(400,0.08,'sine');emitParticles(player.x,player.y-player.radius,'attach_clink');}
        function playGemSound(){createOscillatorSound(1000,0.05,'triangle');createOscillatorSound(1300,0.05,'triangle',0.03);emitParticles(player.x,player.y,'gem_shine');}
        function playBouncyVentSound(){createOscillatorSound(500,0.2,'sine');createOscillatorSound(700,0.15,'triangle',0.05);emitParticles(player.x,player.y-player.radius,'geyser_burst');}
        function playLifeLostSound(){createOscillatorSound(120,0.35,'sawtooth');}function playLevelCompleteSound(){createOscillatorSound(500,0.1,'sine');createOscillatorSound(700,0.1,'sine',0.1);createOscillatorSound(900,0.1,'sine',0.2);}function playGameOverSound(){createOscillatorSound(180,0.45,'sine');createOscillatorSound(90,0.55,'sine',0.15);}function playPowerUpSound(){createOscillatorSound(1000,0.07,'sine');createOscillatorSound(1300,0.07,'sine',0.03);}function playGameWonSound(){createOscillatorSound(600,0.15,'sine');createOscillatorSound(900,0.15,'sine',0.1);createOscillatorSound(1200,0.2,'sine',0.25);}
        muteButtonFromPause.addEventListener('click',toggleMute);function toggleMute(){isMuted=!isMuted;muteButtonFromPause.textContent=isMuted?'Unmute Sounds':'Mute Sounds';if(abyssalDroneMusic){abyssalDroneMusic.muted=isMuted;if(isMuted&&!abyssalDroneMusic.paused)abyssalDroneMusic.pause();}if(cyclingPlatformsMusic){cyclingPlatformsMusic.muted=isMuted;if(isMuted&&!cyclingPlatformsMusic.paused)cyclingPlatformsMusic.pause();}if(!isMuted&&(gameState==='playing'||gameState==='start'||gameState==='gameWon')){attemptPlayMusic();}}
        function prepareMusic(){if(!abyssalDroneMusic){try{abyssalDroneMusic=new Audio('audio/Abyssal_Drone.mp3');abyssalDroneMusic.loop=true;abyssalDroneMusic.volume=0.3;abyssalDroneMusic.muted=isMuted;}catch(e){console.warn("No drone music",e);abyssalDroneMusic=null;}}if(!cyclingPlatformsMusic){try{cyclingPlatformsMusic=new Audio('audio/Cycling_Platforms.mp3');cyclingPlatformsMusic.loop=true;cyclingPlatformsMusic.volume=0.25;cyclingPlatformsMusic.muted=isMuted;}catch(e){console.warn("No cycling music",e);cyclingPlatformsMusic=null;}}}
        function attemptPlayMusic(){prepareMusic();if(abyssalDroneMusic&&!isMuted&&abyssalDroneMusic.paused){abyssalDroneMusic.play().catch(e=>console.error("Drone Music fail:",e));}if(cyclingPlatformsMusic&&!isMuted&&cyclingPlatformsMusic.paused){cyclingPlatformsMusic.play().catch(e=>console.error("Cycling Music fail:",e));}}
        setupTouchControl(leftBtn,'ArrowLeft');setupTouchControl(rightBtn,'ArrowRight');setupTouchControl(jumpBtn,' ');function setupTouchControl(btn,key){btn.addEventListener('touchstart',(e)=>{e.preventDefault();keys[key]=true;if(key===' '&&gameState==='start'){attemptPlayMusic();gameState='playing';playerCanMove=true;updateUIVisibility();keys[' ']=false;}else if(key===' '&&(gameState==='gameOver'||gameState==='gameWon')){attemptPlayMusic();resetGame(true);keys[' ']=false;justRestartedFromGameOver=true;}},{passive:false});btn.addEventListener('touchend',(e)=>{e.preventDefault();keys[key]=false;},{passive:false});btn.addEventListener('mousedown',()=>{keys[key]=true;if(key===' '&&gameState==='start'){attemptPlayMusic();gameState='playing';playerCanMove=true;updateUIVisibility();keys[' ']=false;}else if(key===' '&&(gameState==='gameOver'||gameState==='gameWon')){attemptPlayMusic();resetGame(true);keys[' ']=false;justRestartedFromGameOver=true;}});btn.addEventListener('mouseup',()=>{keys[key]=false;});btn.addEventListener('mouseleave',()=>{keys[key]=false;});}

        pauseButton.addEventListener('click', () => {
            if (gameState === 'playing') {
                gameState = 'paused';
                if (abyssalDroneMusic) abyssalDroneMusic.pause();
                if (cyclingPlatformsMusic) cyclingPlatformsMusic.pause();
                playerCanMove = false;
                updateUIVisibility();
            } else if (gameState === 'gameOver' || gameState === 'gameWon') {
                attemptPlayMusic();
                resetGame(true);
            }
        });

        resumeButton.addEventListener('click',()=>{if(gameState==='paused'){gameState='playing';attemptPlayMusic();playerCanMove=true;updateUIVisibility();}});
        restartFromPauseButton.addEventListener('click',()=>{if(gameState==='paused'||confirm("New Ascent? This will reset your Air Collected and current Depth.")){resetGame(true);}});
        closeAppButton.addEventListener('click',()=>{if(window.AndroidInterface&&typeof window.AndroidInterface.closeApp==='function'){window.AndroidInterface.closeApp();}else{alert("Cannot close.");}});

        class GameEffectParticle{constructor(x,y,type,color,size,vx,vy,lifetime){this.x=x;this.y=y;this.type=type;this.color=color;this.size=size;this.vx=vx*gameSpeedFactor;this.vy=vy*gameSpeedFactor;this.alpha=1;this.lifetime=lifetime/gameSpeedFactor;this.originalLifetime=this.lifetime;this.buoyancyEffect=(type==='push_down_burst'||type==='geyser_burst')?0.09*gameSpeedFactor:((type==='attach_clink')?0.03*gameSpeedFactor:-0.06*gameSpeedFactor);} update(){this.x+=this.vx;this.y+=this.vy;this.vy+=this.buoyancyEffect;this.vy*=0.98;this.vx*=0.98;this.lifetime--;this.alpha=this.lifetime/this.originalLifetime;this.size*=(this.type==='gem_shine'?0.97:0.93);if(this.lifetime<=0||this.size<0.2)this.lifetime=0;} draw(ctx){if(this.lifetime<=0)return;ctx.save();ctx.globalAlpha=this.alpha;ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.x,this.y,this.size,0,Math.PI*2);ctx.fill();ctx.restore();}}
        function emitParticles(x,y,type){let numP,clr,minS,maxS,minVx,maxVx,minVy,maxVy,life;switch(type){case 'gem_shine':numP=6;clr='rgba(200,255,255,0.9)';minS=2;maxS=5;minVx=-1.5;maxVx=1.5;minVy=-1.5;maxVy=1.5;life=35;break;case 'attach_clink':numP=4;clr='rgba(180,180,180,0.6)';minS=3;maxS=6;minVx=-0.5;maxVx=0.5;minVy=0.1;maxVy=0.4;life=25;break;case 'push_down_burst':numP=8;clr='rgba(150,200,255,0.7)';minS=4;maxS=8;minVx=-1.2;maxVx=1.2;minVy=2.5;maxVy=4.5;life=40;break;case 'geyser_burst':numP=12;clr='rgba(200,255,230,0.8)';minS=5;maxS=10;minVx=-1.5;maxVx=1.5;minVy=3.0;maxVy=5.5;life=45;break;default:return;}for(let i=0;i<numP;i++){gameEffectParticles.push(new GameEffectParticle(x+(Math.random()-0.5)*5,y+(Math.random()-0.5)*5,type,clr,minS+Math.random()*(maxS-minS),minVx+Math.random()*(maxVx-minVx),minVy+Math.random()*(maxVy-minVy),life));}}

        class AmbientBubble {
            constructor(isParallaxLayer, type = 'ambient') { // type can be 'ambient', 'foreground'
                this.isParallax = isParallaxLayer; // For ambient, true means background parallax, false means mid-ground
                                               // For foreground, isParallax = true helps disable interactions
                this.type = type;
                this.reset();
            }
            reset() {
                if (this.type === 'foreground') {
                    this.radius = 25 + Math.random() * 25; // Larger: 25-50px
                    this.x = Math.random() * TARGET_CANVAS_WIDTH;
                    this.y = Math.random() * TARGET_CANVAS_HEIGHT; // Start anywhere on screen
                    this.baseSpeedY = -(0.1 + Math.random() * 0.15) * gameSpeedFactor; // Slower
                    this.speedY = this.baseSpeedY;
                    this.speedX = (Math.random() - 0.5) * 0.1 * gameSpeedFactor; // Very little horizontal drift
                    this.alpha = 0.04 + Math.random() * 0.06; // Very transparent
                    this.color = `rgba(200, 235, 255, ${this.alpha})`;
                    this.isParallax = true; // Effectively ensures no interaction
                } else { // 'ambient'
                    this.radius = this.isParallax ? (3 + Math.random() * 7) : (2 + Math.random() * 4);
                    this.x = Math.random() * TARGET_CANVAS_WIDTH;
                    this.y = Math.random() * (TARGET_CANVAS_HEIGHT * 1.2); // Spread from top to a bit below screen
                    this.baseSpeedY = -(this.isParallax ? (0.35 + Math.random() * 0.65) : (0.9 + Math.random() * 2.0)) * gameSpeedFactor;
                    this.speedY = this.baseSpeedY;
                    this.speedX = (Math.random() - 0.5) * (this.isParallax ? 0.25 : 0.45) * gameSpeedFactor;
                    this.alpha = (this.isParallax ? 0.05 : 0.2) + Math.random() * (this.isParallax ? 0.18 : 0.35);
                    this.color = `rgba(170, 220, 255, ${this.alpha})`;
                }
                this.stuckTimer = 0;
                this.platformInfluenceX = 0;
            }
            update() {
                this.y += this.speedY;
                this.x += this.speedX + this.platformInfluenceX;
                this.platformInfluenceX *= 0.85;
                this.speedY *= 0.998; this.speedX *= 0.99;
                if (this.y < -this.radius * 3) { this.reset(); }

                // Interaction logic only for non-parallax ambient bubbles
                if (this.type === 'ambient' && !this.isParallax && this.stuckTimer <= 0) {
                    for (const p of platforms) {
                        if (p.deadly || p.type === 'ocean_floor') continue;
                        const pTop = p.y; const pBottom = p.y + p.height;
                        const pLeft = p.x; const pRight = p.x + p.width;
                        if (this.x + this.radius > pLeft && this.x - this.radius < pRight &&
                            this.y + this.radius > pTop && this.y - this.radius < pBottom) {
                            if (Math.abs(this.speedY) > 0.05) {
                                this.speedY *= -0.3; this.y += this.speedY * 2.5;
                                this.stuckTimer = Math.floor(10 + Math.random() * 20 / gameSpeedFactor);
                            }
                            this.platformInfluenceX += (this.x < p.x + p.width / 2 ? -0.1 : 0.1) * gameSpeedFactor;
                            break;
                        }
                    }
                }
                if (this.stuckTimer > 0) {
                    this.stuckTimer--; this.speedY = this.baseSpeedY * 0.05;
                } else { this.speedY = Math.min(this.speedY, this.baseSpeedY); }
            }
            draw(ctx) {
                ctx.fillStyle = this.color; ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2); ctx.fill();
            }
        }

        class PowerUp{constructor(x,y,type){this.x=x;this.y=y;this.type=type;this.radius=14;this.collected=false;this.scale=1;this.symbol='';this.animationTimer=0;this.animationSpeed=0.06*gameSpeedFactor;switch(this.type){case 'shield_bubble':this.color1='#ADD8E6';this.color2='#87CEEB';this.symbol='SHD';break;case 'propulsion_boost':this.color1='#98FB98';this.color2='#3CB371';this.symbol='BST';break;}}draw(ctx){if(this.collected)return;const offsetY=Math.sin(this.animationTimer)*6;drawCircleWithGradient(this.x,this.y+offsetY,this.radius,this.color1,this.color2,this.scale);ctx.fillStyle='black';ctx.strokeStyle='white';ctx.lineWidth=1.5;ctx.font='bold 11px Arial';ctx.textAlign='center';ctx.strokeText(this.symbol,this.x,this.y+offsetY+4);ctx.fillText(this.symbol,this.x,this.y+offsetY+4);}update(){this.animationTimer+=this.animationSpeed;}}
        function drawCircleWithGradient(x,y,r,c1,c2,s=1){ctx.beginPath();const gr=ctx.createRadialGradient(x,y,0,x,y,r*s);gr.addColorStop(0,c1);gr.addColorStop(1,c2);ctx.fillStyle=gr;ctx.arc(x,y,r*s,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(0,0,0,0.4)';ctx.lineWidth=1.5;ctx.stroke();}
        function drawPlatformCeiling(x,y,w,h,c1,c2,cornerRadius){ctx.beginPath();const grad=ctx.createRadialGradient(x+w/2,y+h/2,0,x+w/2,y+h/2,Math.max(w,h)*0.7);grad.addColorStop(0,c1);grad.addColorStop(1,c2);ctx.fillStyle=grad;if(typeof ctx.roundRect==='function'){ctx.roundRect(x,y,w,h,[cornerRadius]);ctx.fill();ctx.strokeStyle='rgba(0,0,0,0.5)';ctx.lineWidth=2;ctx.stroke();}else{ctx.fillRect(x,y,w,h);ctx.strokeRect(x,y,w,h);}}
        function drawGem(x,y,r,s=1){drawCircleWithGradient(x,y,r,'rgba(100,220,255,0.95)','rgba(50,150,200,0.75)',s);ctx.fillStyle='rgba(220,255,255,0.85)';ctx.beginPath();ctx.arc(x-r*0.3*s,y-r*0.3*s,r*0.25*s,0,Math.PI*2);ctx.fill();}
        function drawAnglerFish(x,y,size,color1,color2){drawCircleWithGradient(x,y,size,color1,color2);ctx.fillStyle=color2;for(let i=0;i<8;i++){const ang=(i/8)*Math.PI*2;ctx.beginPath();ctx.moveTo(x+Math.cos(ang)*size*0.8,y+Math.sin(ang)*size*0.8);ctx.lineTo(x+Math.cos(ang+0.1)*size*1.25,y+Math.sin(ang+0.1)*size*1.25);ctx.lineTo(x+Math.cos(ang-0.1)*size*1.25,y+Math.sin(ang-0.1)*size*1.25);ctx.closePath();ctx.fill();}ctx.fillStyle='white';ctx.beginPath();ctx.arc(x+size*0.3,y-size*0.2,size*0.25,0,Math.PI*2);ctx.fill();ctx.fillStyle='black';ctx.beginPath();ctx.arc(x+size*0.35,y-size*0.2,size*0.12,0,Math.PI*2);ctx.fill();ctx.fillStyle='yellow';ctx.beginPath();ctx.arc(x+size*0.7,y-size*0.7,size*0.15,0,Math.PI*2);ctx.fill();}

        function generateBackgroundColors(){
            let hTop,sTop,lTop,hMid,sMid,lMid,hBot,sBot,lBot;
            const L=(internalLevel-1);
            const brightnessTier=Math.floor(L/3);
            const hueCycleInTier=L%3;
            let baseLightnessDarkest=5+brightnessTier*7;
            baseLightnessDarkest=Math.min(baseLightnessDarkest,45);
            let gradientSpan=Math.max(10,30-brightnessTier*3);
            let currentSaturation=Math.max(30,90-(currentDepth/STARTING_DEPTH)*70-brightnessTier*4);
            if(internalLevel===1){
                gradientBaseHue=220;
                hBot=gradientBaseHue;sBot=0;lBot=0;
                hTop=(hBot+10)%360;
                sTop=Math.max(10,currentSaturation-20);
                lTop=Math.min(20,lBot+gradientSpan);
            } else {
                let prevDarkestHue=gradientBaseHue;
                hBot=(prevDarkestHue+Math.random()*30-15+360)%360;
                sBot=currentSaturation;
                lBot=baseLightnessDarkest;
                hTop=(hBot+10+Math.random()*10+360)%360;
                sTop=Math.max(10,currentSaturation-15);
                lTop=Math.min(80,lBot+gradientSpan);
                gradientBaseHue=hBot;
            }
            if(hueCycleInTier===1){ hTop=(hTop+120)%360; hBot=(hBot+120)%360;
            } else if(hueCycleInTier===2){ hTop=(hTop+240)%360; hBot=(hBot+240)%360; }
            hMid=(hTop+hBot)/2; if(Math.abs(hTop-hBot)>180)hMid=(hMid+180)%360;
            sMid=(sTop+sBot)/2; lMid=(lTop+lBot)/2;
            currentGradientColors=[`hsl(${hTop},${sTop}%,${lTop}%)`,`hsl(${hMid},${sMid}%,${lMid}%)`,`hsl(${hBot},${sBot}%,${lBot}%)`];
        }
        function setupLevelBackgroundEffects() {
            ambientBubbles = [];
            foregroundBubbles = []; // Clear foreground bubbles as well

            const numAmbientBubbles = 35 + Math.floor(internalLevel * 2.5);
            for (let i = 0; i < numAmbientBubbles; i++) {
                ambientBubbles.push(new AmbientBubble(Math.random() < 0.7, 'ambient'));
            }

            const numFgBubbles = 7 + Math.floor(internalLevel * 0.3); // Fewer, scales slowly
            for (let i = 0; i < numFgBubbles; i++) {
                foregroundBubbles.push(new AmbientBubble(true, 'foreground')); // isParallax true for no interaction
            }
        }
        function checkAllOrbsCollected(){if(stars.every(s=>s.collected)){if(!exitPlatform&&stars.length>0){exitPlatform={x:TARGET_CANVAS_WIDTH/2-60,y:EXIT_CEILING_UNDERSIDE_Y-EXIT_CEILING_HEIGHT,width:120,height:EXIT_CEILING_HEIGHT,color1:'#607D8B',color2:'#455A64',static:true,type:'exit_portal_ceiling',active:true};}}}

        function initLevel(isFullReset = false) {
            platforms=[];enemies=[];stars=[];powerUps=[];gameEffectParticles=[];exitPlatform=null;seaFloorDecorations=[];
            // ambientBubbles and foregroundBubbles are cleared and repopulated in setupLevelBackgroundEffects
            if(isFullReset){internalLevel=1;currentDepth=STARTING_DEPTH;airCollected=0;player.lives=3;gradientBaseHue=200;player.radius=player.baseRadius;player.currentPushForce=PLAYER_BASE_PUSH_INITIAL;}
            generateBackgroundColors();setupLevelBackgroundEffects(); // This now sets up both bubble types
            const startCeilingH=20;const startCeilingTopY=TARGET_CANVAS_HEIGHT-150;
            platforms.push({x:TARGET_CANVAS_WIDTH/2-70,y:startCeilingTopY,width:140,height:startCeilingH,color1:'#546E7A',color2:'#37474F',static:false,type:'start_ceiling',active:true,direction:1,speed:platformBaseSpeed*0.6});
            player.x=platforms[0].x+platforms[0].width/2;player.y=platforms[0].y+platforms[0].height+player.radius+40;player.vx=0;player.vy=0;player.isAttached=false;player.attachedPlatform=null;player.canTakeDamage=true;clearTimeout(player.damageCooldownTimeout);player.invincible=false;player.invincibleTimer=0;player.speedBoost=false;player.speedBoostTimer=0;
            let currentCeilingUndersideY=platforms[0].y+platforms[0].height;const highestPossibleCeilingTopY=TOP_SURFACE_DEATH_Y+player.radius+EXIT_CEILING_HEIGHT+20;
            let numDynamicCeilings=3+Math.floor(internalLevel*1.1);const availableVSpace=currentCeilingUndersideY-highestPossibleCeilingTopY;
            let dynamicMaxFloat = (player.currentPushForce * player.currentPushForce) / (2*Math.abs(BUOYANCY));
            let minGapForGen=dynamicMaxFloat*MIN_CEILING_UNDERSIDE_GAP_FACTOR;
            if(availableVSpace>0){numDynamicCeilings=Math.min(numDynamicCeilings,Math.floor(availableVSpace/(minGapForGen+startCeilingH)));}else{numDynamicCeilings=0;}
            numDynamicCeilings=Math.max(numDynamicCeilings,internalLevel===1?1:2);let dynamicCeilingCfgs=[];
            let specialCeilingsToGen=[];if(internalLevel>1){let count=0;if(internalLevel>=2&&internalLevel<4)count=1;else if(internalLevel>=4&&internalLevel<6)count=2;else if(internalLevel>=6)count=Math.min(3,1+Math.floor((internalLevel-4)/2.5));for(let k=0;k<count;k++)specialCeilingsToGen.push(SPECIAL_PLATFORM_TYPES[Math.floor(Math.random()*SPECIAL_PLATFORM_TYPES.length)]);}
            for(let i=0;i<numDynamicCeilings;i++){
                let platW = 180 - internalLevel * 10; platW = Math.max(90, platW) + Math.random() * (internalLevel < 5 ? 50 : 20);
                const platH=20;let platX=Math.random()*(TARGET_CANVAS_WIDTH-platW);
                dynamicMaxFloat = (player.currentPushForce * player.currentPushForce) / (2*Math.abs(BUOYANCY));
                let currentMinGap = dynamicMaxFloat*MIN_CEILING_UNDERSIDE_GAP_FACTOR;
                let currentMaxGap = dynamicMaxFloat*MAX_CEILING_UNDERSIDE_GAP_FACTOR;
                let newCeilingUndersideY_max=currentCeilingUndersideY-currentMinGap;let newCeilingUndersideY_min=currentCeilingUndersideY-currentMaxGap;newCeilingUndersideY_min=Math.max(newCeilingUndersideY_min,highestPossibleCeilingTopY+platH);
                if(newCeilingUndersideY_min>=newCeilingUndersideY_max-platH/1.5){break;}
                let y_under=Math.random()*(newCeilingUndersideY_max-newCeilingUndersideY_min)+newCeilingUndersideY_min;let y_top=y_under-platH;
                let currentType='normal_ceiling';let pC1='#607D8B',pC2='#455A64';
                let platSpd = platformBaseSpeed * (0.5 + internalLevel*0.07 + Math.random()*0.25); platSpd = Math.min(platSpd, platformBaseSpeed * 3.0);
                let platDir=(Math.random()<0.5?1:-1);let isStat=false;
                let willHaveEnemy = (enemies.length < Math.floor(internalLevel/2.0)+ (internalLevel > 2 ? 1:0) && Math.random() < 0.03 + internalLevel*0.08 && i > 0 && internalLevel > 2);
                if(willHaveEnemy && internalLevel<8) platW = Math.max(platW, 150);

                if(specialCeilingsToGen.length>0&&Math.random()<(0.1 + internalLevel*0.06)){
                    currentType=specialCeilingsToGen.shift();
                    switch(currentType){
                        case 'disappearing_coral':pC1='#FFAB91';pC2='#FF7043';isStat=true;break;
                        case 'bouncy_vent':pC1='#80CBC4';pC2='#26A69A';isStat=true;platSpd=0;break;
                        case 'conveyor_current':pC1='#E8D57D';pC2='#D4B55A';isStat=false;platSpd*=1.3;break;
                    }
                }
                let platformData={x:platX,y:y_top,width:platW,height:platH,color1:pC1,color2:pC2,static:isStat,type:currentType,active:true,direction:platDir,speed:platSpd,originalColor1:pC1,timer:Math.floor(80/gameSpeedFactor),reappearTime:Math.floor(180/gameSpeedFactor)};
                dynamicCeilingCfgs.push(platformData);
                if(willHaveEnemy && currentType !=='disappearing_coral' && currentType !=='bouncy_vent'){
                    enemies.push({x:platformData.x+platformData.width/2,y:platformData.y+platformData.height+20,size:16,platformAttached:platformData,direction:Math.random()>0.5?1:-1,speed:platformBaseSpeed*(0.3+internalLevel*0.04+Math.random()*0.3),color1:'#FF6F00',color2:'#E65100'});
                }
                currentCeilingUndersideY=y_under;}
            dynamicCeilingCfgs.sort((a,b)=>b.y-a.y);platforms.splice(1,0,...dynamicCeilingCfgs);
            if(internalLevel===1){platforms.push({x:0,y:TARGET_CANVAS_HEIGHT-BOTTOM_DEATH_FLOOR_HEIGHT,width:TARGET_CANVAS_WIDTH,height:BOTTOM_DEATH_FLOOR_HEIGHT,color1:'#3E2723',color2:'#201512',static:true,deadly:true,type:'ocean_floor',active:true});for(let i=0;i<10+Math.random()*10;i++){seaFloorDecorations.push({x:Math.random()*TARGET_CANVAS_WIDTH,baseY:TARGET_CANVAS_HEIGHT-BOTTOM_DEATH_FLOOR_HEIGHT,h:10+Math.random()*30,w:3+Math.random()*4,color:`rgba(${50+Math.random()*50},${100+Math.random()*50},${50+Math.random()*50},0.7)`});}}
            stars=[];const gemR=11;const numGems=Math.max(2,Math.floor(platforms.filter(p=>p.type!=='start_ceiling'&&p.type!=='ocean_floor').length/1.8)+Math.floor(internalLevel/1.2));for(let i=0;i<numGems;i++){let v=false;let gX,gY;let att=0;while(!v&&att<50){att++;const cPs=platforms.filter(p=>p.type!=='start_ceiling'&&p.type!=='ocean_floor'&&!p.deadly);if(cPs.length===0)break;const bC=cPs[Math.floor(Math.random()*cPs.length)];gX=bC.x+Math.random()*bC.width;gY=bC.y+bC.height+gemR+(15+Math.random()*35);const floorBoundary=(internalLevel===1?(TARGET_CANVAS_HEIGHT-BOTTOM_DEATH_FLOOR_HEIGHT):TARGET_CANVAS_HEIGHT);gY=Math.min(gY,floorBoundary-gemR-10);v=true;for(const pl of platforms){if(gX+gemR>pl.x&&gX-gemR<pl.x+pl.width&&gY+gemR>pl.y&&gY-gemR<pl.y+pl.height){v=false;break;}}if(!v)continue;for(const oG of stars){const dx=gX-oG.x;const dy=gY-oG.y;if(Math.sqrt(dx*dx+dy*dy)<gemR*3.5){v=false;break;}}}if(v){stars.push({x:gX,y:gY,radius:gemR,scale:1,collected:false,bobOffset:Math.random()*Math.PI*2,bobSpeed:0.025+Math.random()*0.02});}}checkAllOrbsCollected();
        }

        function update(){
            if(justRestartedFromGameOver && !keys[' ']){ justRestartedFromGameOver = false; }
            switch(gameState){
                case 'start':
                    if(keys[' ']){ playerCanMove=true; gameState='playing'; keys[' ']=false; updateUIVisibility(); attemptPlayMusic(); }
                    break;
                case 'playing':
                    if(keys['p']||keys['Escape']){ gameState='paused'; keys['p']=false; keys['Escape']=false; if(abyssalDroneMusic) abyssalDroneMusic.pause(); if(cyclingPlatformsMusic) cyclingPlatformsMusic.pause(); playerCanMove=false; updateUIVisibility(); }
                    updatePlayer(); updatePlatforms(); updateEnemies(); updateStars(); updatePowerUps(); updateGameEffectParticles(); updateAmbientBubbles(); checkExitPlatform();
                    break;
                case 'paused': break;
                case 'transitioning':
                    transitionAlpha+=transitionSpeed;
                    if(transitionAlpha>=1){ transitionAlpha=1; if(transitionCallback) transitionCallback(); transitionSpeed*=-1;
                    } else if(transitionAlpha<=0){ transitionAlpha=0; transitionSpeed=Math.abs(transitionSpeed); gameState=(transitionCallback&&typeof transitionCallback.toString==='function'&&transitionCallback.toString().includes("gameState='gameOver'"))?'gameOver':(transitionCallback&&typeof transitionCallback.toString==='function'&&transitionCallback.toString().includes("gameState='gameWon'"))?'gameWon':'playing'; playerCanMove = gameState === 'playing'; updateUIVisibility(); }
                    break;
                case 'gameOver':
                    if ((keys[' '] || keys['p'] || keys['Escape']) && !justRestartedFromGameOver) { attemptPlayMusic(); resetGame(true); if (keys[' ']) keys[' '] = false; if (keys['p']) keys['p'] = false; if (keys['Escape']) keys['Escape'] = false; justRestartedFromGameOver = true; }
                    break;
                case 'gameWon':
                     if ((keys[' '] || keys['p'] || keys['Escape']) && !justRestartedFromGameOver) { attemptPlayMusic(); resetGame(true); if (keys[' ']) keys[' '] = false; if (keys['p']) keys['p'] = false; if (keys['Escape']) keys['Escape'] = false; justRestartedFromGameOver = true; }
                    break;
            }
        }
        function updatePlayer(){if(!playerCanMove){player.vx=0;return;}player.currentPushForce=PLAYER_BASE_PUSH_INITIAL-(player.radius-player.baseRadius)*0.30;player.currentPushForce=Math.max(player.currentPushForce,PLAYER_BASE_PUSH_INITIAL*0.25);let currentSpeed=player.baseSpeed;if(player.speedBoost){currentSpeed*=1.7;player.speedBoostTimer--;if(player.speedBoostTimer<=0)player.speedBoost=false;}if(keys.ArrowLeft)player.vx=Math.max(player.vx-(0.3*gameSpeedFactor),-currentSpeed);else if(keys.ArrowRight)player.vx=Math.min(player.vx+(0.3*gameSpeedFactor),currentSpeed);else player.vx*=WATER_RESISTANCE_H;player.x+=player.vx;if(keys[' ']&&player.isAttached){player.vy=player.currentPushForce;player.isAttached=false;player.attachedPlatform=null;playPushFromCeilingSound();}if(!player.isAttached){player.vy+=BUOYANCY;let pulled=false;for(const platform of platforms.concat(exitPlatform?[exitPlatform]:[])){if(!platform||!platform.active||platform.deadly||platform.type==='ocean_floor')continue;if(player.vy<0&&player.y-player.radius<platform.y+platform.height+10&&player.y+player.radius>platform.y-10&&player.x+player.radius*0.8>platform.x&&player.x-player.radius*0.8<platform.x+platform.width){player.vy+=PLATFORM_ATTACH_PULL_UP;pulled=true;if(player.y-player.radius<platform.y+platform.height&&player.y-player.vy-player.radius>=platform.y+platform.height-1.5){player.y=platform.y+platform.height+player.radius;player.vy=0;player.isAttached=true;player.attachedPlatform=platform;playAttachToCeilingSound();if(platform.type==='bouncy_vent'){player.vy=player.currentPushForce*1.7;player.isAttached=false;player.attachedPlatform=null;playBouncyVentSound();}else if(platform.type==='exit_portal_ceiling'){checkExitPlatform();}break;}}}}player.vy*=WATER_RESISTANCE_V;player.y+=player.vy;if(player.x<player.radius){player.x=player.radius;player.vx*=-0.3;}if(player.x>TARGET_CANVAS_WIDTH-player.radius){player.x=TARGET_CANVAS_WIDTH-player.radius;player.vx*=-0.3;}if(player.y-player.radius<TOP_SURFACE_DEATH_Y&&!player.invincible&&player.canTakeDamage){playerDie("surfaced_abyss");}if(player.isAttached&&player.attachedPlatform){const p=player.attachedPlatform;let stillOn=(player.x+player.radius*0.7>p.x&&player.x-player.radius*0.7<p.x+p.width);if(stillOn){player.y=p.y+p.height+player.radius;if(!p.static)player.x+=p.direction*p.speed;if(p.type==='conveyor_current')player.x+=p.direction*p.speed*1.7;}else{player.isAttached=false;player.attachedPlatform=null;}}const deadlyFloor=platforms.find(p=>p.type==='ocean_floor');if(internalLevel===1&&deadlyFloor&&player.y+player.radius>deadlyFloor.y&&!player.invincible&&player.canTakeDamage){playerDie("hit_floor");}else if(internalLevel>1&&player.y+player.radius>TARGET_CANVAS_HEIGHT+player.radius&&!player.invincible&&player.canTakeDamage){playerDie("fell_off_bottom");}if(player.invincibleTimer>0){player.invincibleTimer--;if(player.invincibleTimer<=0){player.invincible=false;player.canTakeDamage=true;clearTimeout(player.damageCooldownTimeout);}}for(let i=stars.length-1;i>=0;i--){const gem=stars[i];if(!gem.collected){const dx=player.x-gem.x;const dy=player.y-(gem.y+Math.sin(gem.bobOffset+frameCount*gem.bobSpeed)*3);if(Math.sqrt(dx*dx+dy*dy)<player.radius+gem.radius){gem.collected=true;airCollected+=20;player.radius=Math.min(player.maxRadius,player.radius+player.radiusGrowthPerStar);playGemSound();checkAllOrbsCollected();}}}for(let i=powerUps.length-1;i>=0;i--){}for(const enemy of enemies){const dx=player.x-enemy.x;const dy=player.y-enemy.y;if(Math.sqrt(dx*dx+dy*dy)<player.radius+enemy.size*0.7&&!player.invincible&&player.canTakeDamage){playerDie("hit_enemy");player.vy=(BUOYANCY>0?1.5:-1.5)*2*gameSpeedFactor;player.vx=(dx>0?4:-4)*gameSpeedFactor;}}updateUI();}
        function updatePlatforms(){for(let i=0;i<platforms.length;i++){const p=platforms[i];if(!p.static&&!p.deadly&&p.type!=='ocean_floor'){let oldDirection=p.direction;p.x+=p.direction*p.speed;if(p.x<=0||p.x+p.width>=TARGET_CANVAS_WIDTH){p.direction*=-1;p.x=Math.max(0,Math.min(p.x,TARGET_CANVAS_WIDTH-p.width));if(oldDirection!==p.direction){for(const enemy of enemies){if(enemy.platformAttached===p)enemy.direction=p.direction;}}}}if(p.type==='disappearing_coral'&&p.active){if(player.isAttached&&player.attachedPlatform===p){p.timer--;}if(p.timer<=0){p.active=false;if(player.isAttached&&player.attachedPlatform===p){player.isAttached=false;player.attachedPlatform=null;player.vy=BUOYANCY*4;}setTimeout(()=>{p.active=true;p.originalColor1&&(p.color1=p.originalColor1);p.timer=Math.floor(80/gameSpeedFactor);},Math.floor(p.reappearTime));}}}}
        function updateEnemies(){for(const enemy of enemies){if(!enemy.platformAttached||!enemy.platformAttached.active){enemy.speed*=0.95; enemy.y += BUOYANCY*0.5; if(enemy.y < -enemy.size*2) enemies.splice(enemies.indexOf(enemy),1); continue;}const p=enemy.platformAttached;enemy.x+=enemy.direction*enemy.speed;const patrolMargin=5;if(enemy.x-enemy.size<p.x+patrolMargin||enemy.x+enemy.size>p.x+p.width-patrolMargin){enemy.direction*=-1;enemy.x=Math.max(p.x+patrolMargin+enemy.size,Math.min(enemy.x,p.x+p.width-patrolMargin-enemy.size));}enemy.y=p.y+p.height+enemy.size+5;}}
        function updateStars(){stars.forEach(star=>{if(!star.collected){star.bobOffset+=star.bobSpeed;}})}function updatePowerUps(){}function updateGameEffectParticles(){for(let i=gameEffectParticles.length-1;i>=0;i--){gameEffectParticles[i].update();if(gameEffectParticles[i].lifetime<=0||gameEffectParticles[i].size<=0.1){gameEffectParticles.splice(i,1);}}}
        function updateAmbientBubbles(){
            for(const b of ambientBubbles){ b.update(); }
            for(const b of foregroundBubbles){ b.update(); } // Update foreground bubbles too
        }
        function playerDie(reason="unknown"){if(!player.canTakeDamage&&!player.invincible&&!reason.includes("surfaced")&&!reason.includes("hit_floor")&&!reason.includes("fell_off_bottom"))return;if(player.invincible&&!reason.includes("surfaced")&&!reason.includes("hit_floor")&&!reason.includes("fell_off_bottom"))return;player.lives--;playLifeLostSound();updateUI();if(player.lives<=0){gameOver=true;gameOverFinalAir=airCollected;if(airCollected>totalAirHighScore){totalAirHighScore=airCollected;localStorage.setItem('abyssalAscentTotalAir_v9',totalAirHighScore);}playerCanMove=false;gameState='transitioning';transitionCallback=()=>{gameState='gameOver';playGameOverSound();updateUIVisibility();};}else{playerCanMove=false;gameState='transitioning';transitionCallback=()=>{if(platforms.length>0&&platforms[0].type==='start_ceiling'){player.x=platforms[0].x+platforms[0].width/2;player.y=platforms[0].y+platforms[0].height+player.radius+40;player.isAttached=false;player.attachedPlatform=null;}else{player.x=TARGET_CANVAS_WIDTH/2;player.y=TARGET_CANVAS_HEIGHT-100;player.isAttached=false;}player.vx=0;player.vy=0;player.radius=player.baseRadius;player.currentPushForce=PLAYER_BASE_PUSH_INITIAL;player.invincible=true;player.invincibleTimer=Math.floor(120/gameSpeedFactor);updateUIVisibility();};}}
        function checkExitPlatform(){if(exitPlatform&&player.isAttached&&player.attachedPlatform===exitPlatform){if(gameState==='playing'){airCollected+=100*internalLevel;currentDepth-=DEPTH_DECREASE_PER_LEVEL;if(currentDepth<=0){currentDepth=0;gameState='transitioning';playerCanMove=false;transitionCallback=()=>{gameState='gameWon';playGameWonSound();if(airCollected>totalAirHighScore){totalAirHighScore=airCollected;localStorage.setItem('abyssalAscentTotalAir_v9',totalAirHighScore);}updateUIVisibility();};return;}playLevelCompleteSound();playerCanMove=false;gameState='transitioning';transitionCallback=()=>{internalLevel++;platformBaseSpeed+=0.02;player.radius=player.baseRadius;player.currentPushForce=PLAYER_BASE_PUSH_INITIAL;initLevel();updateUIVisibility();};}}}
        function drawBackground(){const grad=ctx.createLinearGradient(0,0,0,TARGET_CANVAS_HEIGHT);currentGradientColors.forEach((c,i)=>{grad.addColorStop(i/(currentGradientColors.length-1),c);});ctx.fillStyle=grad;ctx.fillRect(0,0,TARGET_CANVAS_WIDTH,TARGET_CANVAS_HEIGHT);}
        function drawGameElements(){
            drawBackground();
            for(const b of ambientBubbles){if(b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);}
            for(const p of platforms){if(p.active)drawPlatformCeiling(p.x,p.y,p.width,p.height,p.color1,p.color2,PLATFORM_CORNER_RADIUS);}
            if(exitPlatform&&exitPlatform.active){drawPlatformCeiling(exitPlatform.x,exitPlatform.y,exitPlatform.width,exitPlatform.height,exitPlatform.color1,exitPlatform.color2,PLATFORM_CORNER_RADIUS);ctx.fillStyle='white';ctx.strokeStyle='#104010';ctx.lineWidth=2;ctx.font='bold 14px Arial';ctx.textAlign='center';ctx.strokeText('ASCEND',exitPlatform.x+exitPlatform.width/2,exitPlatform.y+exitPlatform.height/2+5);ctx.fillText('ASCEND',exitPlatform.x+exitPlatform.width/2,exitPlatform.y+exitPlatform.height/2+5);}
            if(internalLevel===1){for(const decor of seaFloorDecorations){ctx.fillStyle=decor.color;ctx.fillRect(decor.x-decor.w/2,decor.baseY-decor.h,decor.w,decor.h);}}
            for(const gem of stars){if(!gem.collected)drawGem(gem.x,gem.y+Math.sin(gem.bobOffset+frameCount*gem.bobSpeed)*3,gem.radius,gem.scale);}
            for(const enemy of enemies){drawAnglerFish(enemy.x,enemy.y,enemy.size,enemy.color1,enemy.color2);}
            let pC1='#70C1FF',pC2='#2A7AB0';if(player.invincibleTimer>0&&Math.floor(player.invincibleTimer/5)%2===0){pC1='#FFFACD';pC2='#FFD700';}drawCircleWithGradient(player.x,player.y,player.radius,pC1,pC2,player.scale);
            if(player.isAttached&&player.attachedPlatform){ctx.strokeStyle='rgba(220,240,255,0.4)';ctx.lineWidth=player.radius*0.12;ctx.beginPath();ctx.moveTo(player.x,player.y-player.radius);ctx.lineTo(player.x,player.attachedPlatform.y+player.attachedPlatform.height);ctx.stroke();
            }else{ctx.fillStyle='rgba(220,240,255,0.15)';ctx.beginPath();ctx.arc(player.x-player.radius*0.35,player.y-player.radius*0.35,player.radius*0.2,0,Math.PI*2);ctx.fill();}
            for(const p of gameEffectParticles){if(p&&typeof p.draw==='function')p.draw(ctx);}
            for(const b of ambientBubbles){if(!b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Non-parallax ambient bubbles
            const infoTxt=`Air: ${airCollected} | Depth: ${currentDepth}m | Bubbles: ${player.lives}`;ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=2.5;ctx.font='bold 17px Arial';ctx.textAlign='left';ctx.strokeText(infoTxt,10,30);ctx.fillText(infoTxt,10,30);
        }
        function drawStartScreen(){
            drawBackground();
            for(const b of ambientBubbles){if(b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Parallax ambient
            drawScreenMessage("ABYSSAL ASCENT","Press PUSH to Detach & Ascend",'#A7FFEB','white',30,18);
            ctx.font='bold 13px Arial';ctx.lineWidth=2;ctx.fillStyle='white';ctx.strokeStyle='black';
            ctx.strokeText("Arrow Keys: Move Along Ceiling | SPACE/Button: PUSH Down",TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+55);
            ctx.fillText("Arrow Keys: Move Along Ceiling | SPACE/Button: PUSH Down",TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+55);
            ctx.strokeText("Collect Air Bubbles, reach the Surface Exit. Don't hit the floor!",TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+75);
            ctx.fillText("Collect Air Bubbles, reach the Surface Exit. Don't hit the floor!",TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+75);
            for(const b of ambientBubbles){if(!b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Non-parallax ambient
        }
        function drawScreenMessage(title,msg,tc,mc,ts,ms){ctx.fillStyle=tc;ctx.strokeStyle='black';ctx.lineWidth=4;ctx.font=`bold ${ts}px Arial`;ctx.textAlign='center';ctx.strokeText(title,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2-25);ctx.fillText(title,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2-25);if(msg){ctx.fillStyle=mc;ctx.font=`bold ${ms}px Arial`;ctx.lineWidth=3;ctx.strokeText(msg,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+25);ctx.fillText(msg,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+25);}}
        function drawGameOverScreen(){
            drawBackground();
            for(const b of ambientBubbles){if(b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Parallax ambient
            drawScreenMessage("LOST TO THE ABYSS",`Total Air: ${gameOverFinalAir}`,'#FF8A80','white',36,22);
            ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=3;ctx.font='bold 24px Arial';ctx.textAlign='center';
            ctx.strokeText(`Best Total Air: ${totalAirHighScore}`,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+65);
            ctx.fillText(`Best Total Air: ${totalAirHighScore}`,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+65);
            ctx.font='bold 16px Arial';ctx.fillText("DEEPEST POINT REACHED",TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+40);
            ctx.font='bold 19px Arial';ctx.strokeText('Press PUSH to Try Again',TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+105);
            ctx.fillText('Press PUSH to Try Again',TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+105);
            for(const b of ambientBubbles){if(!b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Non-parallax ambient
        }
        function drawGameWonScreen(){
            drawBackground();
            for(const b of ambientBubbles){if(b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Parallax ambient
            drawScreenMessage("SURFACE REACHED!",`Total Air: ${airCollected}`,'#81C784','white',38,24);
            ctx.fillStyle='white';ctx.strokeStyle='black';ctx.lineWidth=3;ctx.font='bold 24px Arial';ctx.textAlign='center';
            ctx.strokeText(`Best Total Air: ${totalAirHighScore}`,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+65);
            ctx.fillText(`Best Total Air: ${totalAirHighScore}`,TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+65);
            ctx.font='bold 19px Arial';ctx.strokeText('Press PUSH to Dive Again!',TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+105);
            ctx.fillText('Press PUSH to Dive Again!',TARGET_CANVAS_WIDTH/2,TARGET_CANVAS_HEIGHT/2+105);
            for(const b of ambientBubbles){if(!b.isParallax&&b&&typeof b.draw==='function')b.draw(ctx);} // Non-parallax ambient
        }
        function drawTransitionOverlay(){ctx.fillStyle=`rgba(0,5,10,${transitionAlpha})`;ctx.fillRect(0,0,TARGET_CANVAS_WIDTH,TARGET_CANVAS_HEIGHT);}

        function draw(){
            if (gameState !== 'paused') {
                ctx.clearRect(0,0,TARGET_CANVAS_WIDTH,TARGET_CANVAS_HEIGHT);
                if(gameState==='start'){
                    drawStartScreen();
                } else if(gameState==='playing'||gameState==='levelComplete'||gameState==='transitioning'){
                    drawGameElements();
                } else if(gameState==='gameOver'){
                    drawGameOverScreen();
                } else if(gameState==='gameWon'){
                    drawGameWonScreen();
                } else {
                    ctx.fillStyle='#AA0000';ctx.fillRect(0,0,TARGET_CANVAS_WIDTH,TARGET_CANVAS_HEIGHT);
                    ctx.fillStyle='yellow';ctx.fillRect(20,20,60,60);
                    ctx.fillStyle='white';ctx.font='14px Arial';ctx.fillText(`Unknown GS: ${gameState}`,20,100);
                    console.error("DRAW IN UNKNOWN GAMESTATE:",gameState);
                }

                // Draw foreground bubbles on top of all game screens (except pause menu)
                if (foregroundBubbles && foregroundBubbles.length > 0) {
                     for (const b of foregroundBubbles) {
                        if (b && typeof b.draw === 'function') b.draw(ctx);
                    }
                }

                if(gameState==='transitioning'){
                    drawTransitionOverlay(); // Transition overlay on top of everything
                }
            }
        }

        function resetGame(isFullResetFromMenuOrGameOver = false){
            if(isFullResetFromMenuOrGameOver){
                player.lives=3;airCollected=0;currentDepth=STARTING_DEPTH;internalLevel=1;
                platformBaseSpeed=0.45*gameSpeedFactor;gradientBaseHue=200;
                player.radius=player.baseRadius;player.currentPushForce=PLAYER_BASE_PUSH_INITIAL;
                totalAirHighScore=parseInt(localStorage.getItem('abyssalAscentTotalAir_v9')||'0',10);
            }
            initLevel(isFullResetFromMenuOrGameOver); // This will also call setupLevelBackgroundEffects
            gameState='playing';
            playerCanMove=true;
            player.canTakeDamage=true;clearTimeout(player.damageCooldownTimeout);
            player.invincible=false;player.invincibleTimer=0;
            player.speedBoost=false;player.speedBoostTimer=0;
            transitionAlpha=0;transitionSpeed=Math.abs(transitionSpeed);transitionCallback=null;
            gameEffectParticles=[];
            // ambientBubbles and foregroundBubbles are reset by initLevel -> setupLevelBackgroundEffects
            attemptPlayMusic();
            updateUIVisibility();
            gameOver=false;
        }

        let frameCount=0;
        function gameLoop(timestamp){
            update();
            draw();
            frameCount++;
            requestAnimationFrame(gameLoop);
        }

        initLevel(true);
        prepareMusic();
        updateUIVisibility();
        gameLoop();
    </script>
</body>
</html>
